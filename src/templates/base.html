<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}News Agent{% endblock %}</title>

    <!-- Preconnect to external resources -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>

    <!-- Bootstrap CSS (Local) - Critical -->
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">

    <!-- Font Awesome (CDN) - Load async with fallback -->
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"></noscript>
    <!-- Custom CSS -->
    <style>
        /* Prevent horizontal scroll on mobile */
        html, body {
            overflow-x: hidden;
            max-width: 100%;
        }

        .container-fluid {
            padding-left: 15px;
            padding-right: 15px;
        }

        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .sidebar .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            margin: 0.25rem 0;
        }
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            color: white;
            background-color: rgba(255,255,255,0.1);
        }
        .sidebar .nav-link i {
            margin-right: 0.5rem;
            width: 1.25rem;
        }
        .main-content {
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .card {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border-radius: 0.75rem;
        }
        .card-header {
            background-color: white;
            border-bottom: 1px solid #e9ecef;
            border-radius: 0.75rem 0.75rem 0 0 !important;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 0.5rem;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .stats-card .card-body {
            padding: 1.5rem;
        }
        .stats-number {
            font-size: 2rem;
            font-weight: bold;
        }
        .article-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .article-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        .sentiment-positive { color: #28a745; }
        .sentiment-negative { color: #dc3545; }
        .sentiment-neutral { color: #6c757d; }
        .sentiment-mixed { color: #ffc107; }

        /* Mobile responsive improvements */
        @media (max-width: 768px) {
            .main-content {
                padding-left: 10px !important;
                padding-right: 10px !important;
            }

            .stats-number {
                font-size: 1.5rem;
            }

            .card-header h5 {
                font-size: 1rem;
            }

            /* Ensure charts are responsive */
            canvas {
                max-width: 100% !important;
                height: auto !important;
            }

            /* Make buttons stack on mobile */
            .btn-toolbar {
                flex-direction: column;
            }

            /* Reduce padding on mobile */
            .card-body {
                padding: 1rem;
            }
        }

        /* Extra small devices */
        @media (max-width: 375px) {
            .container-fluid {
                padding-left: 10px;
                padding-right: 10px;
            }

            h1, .h2 {
                font-size: 1.5rem;
            }
        }
    </style>
    
    {% block extra_css %}{% endblock %}
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <h4 class="text-white">
                            <i class="fas fa-newspaper"></i>
                            News Agent
                        </h4>
                    </div>
                    
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="/">
                                <i class="fas fa-home"></i>
                                Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/articles">
                                <i class="fas fa-newspaper"></i>
                                Articles
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/sources">
                                <i class="fas fa-rss"></i>
                                Sources
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showServiceControls()">
                                <i class="fas fa-history"></i>
                                Recent Activity
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>
            
            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">{% block page_title %}Dashboard{% endblock %}</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        {% block page_actions %}{% endblock %}
                    </div>
                </div>
                
                {% block content %}{% endblock %}
            </main>
        </div>
    </div>
    
    <!-- Service Control Modal -->
    <div class="modal fade" id="serviceModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-cog"></i> Service Control</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Control Buttons -->
                    <div class="mb-4">
                        <h6 class="mb-3"><i class="fas fa-play-circle"></i> Service Controls</h6>
                        <div class="d-grid gap-2 d-md-flex justify-content-md-start">
                            <button class="btn btn-primary" onclick="initializeService()">
                                <i class="fas fa-play"></i> Initialize
                            </button>
                            <button class="btn btn-success" onclick="startService()">
                                <i class="fas fa-play-circle"></i> Start
                            </button>
                            <button class="btn btn-warning" onclick="stopService()">
                                <i class="fas fa-stop-circle"></i> Stop
                            </button>
                        </div>
                    </div>

                    <!-- Service Status Alert -->
                    <div id="serviceStatus" class="alert alert-info" style="display: none;"></div>

                    <!-- Recent Activity -->
                    <div class="mb-4">
                        <h6 class="mb-3"><i class="fas fa-history"></i> Recent Activity</h6>
                        <div id="serviceRecentActivity" class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                            <div class="text-center text-muted">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                <small class="ms-2">Loading activity...</small>
                            </div>
                        </div>
                    </div>

                    <!-- Service Logs -->
                    <div>
                        <h6 class="mb-3"><i class="fas fa-file-alt"></i> Service Logs</h6>
                        <div id="serviceLogs" class="border rounded p-3 bg-dark text-light" style="max-height: 250px; overflow-y: auto; font-family: monospace; font-size: 0.85rem;">
                            <div class="text-center text-muted">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                <small class="ms-2">Loading logs...</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="refreshServiceInfo()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS (Local) - Defer loading -->
    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}" defer></script>
    <!-- jQuery (Local) - Defer loading -->
    <script src="{{ url_for('static', filename='js/jquery-3.6.0.min.js') }}" defer></script>

    <!-- Custom JavaScript -->
    <script>
        // Function to initialize after all libraries are loaded
        function initializeApp() {
            // Service Control Modal functions
            window.showServiceControls = function() {
                try {
                    if (typeof bootstrap !== 'undefined') {
                        const modal = new bootstrap.Modal(document.getElementById('serviceModal'));
                        modal.show();
                        loadServiceInfo();
                    } else if (typeof $ !== 'undefined') {
                        $('#serviceModal').modal('show');
                        loadServiceInfo();
                    } else {
                        console.error('Bootstrap not loaded yet');
                        alert('Please wait for the page to fully load and try again.');
                    }
                } catch (error) {
                    console.error('Error showing modal:', error);
                    alert('Error opening Recent Activity. Please refresh the page.');
                }
            };

            window.refreshServiceInfo = function() {
                loadServiceInfo();
            };

            async function loadServiceInfo() {
                await Promise.all([
                    loadServiceActivity(),
                    loadServiceLogs()
                ]);
            }

            async function loadServiceActivity() {
                try {
                    const activityDiv = document.getElementById('serviceRecentActivity');

                    // Get status from API
                    const response = await fetch('/api/news/status', {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    if (!response.ok) {
                        throw new Error('Failed to fetch service status');
                    }

                    const data = await response.json();

                    if (data.success && data.data) {
                        const status = data.data;
                        let activityHtml = '<div class="list-group list-group-flush">';

                        // Show service status
                        activityHtml += `
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <strong>Service Status:</strong>
                                    <span class="badge ${status.service_running ? 'bg-success' : 'bg-secondary'}">
                                        ${status.service_running ? 'Running' : 'Stopped'}
                                    </span>
                                </div>
                            </div>
                        `;

                        // Show collector information
                        if (status.collectors && Object.keys(status.collectors).length > 0) {
                            for (const [collectorId, collector] of Object.entries(status.collectors)) {
                                const lastCollection = collector.last_collection
                                    ? new Date(collector.last_collection).toLocaleString()
                                    : 'Never';

                                const statusBadge = collector.is_running
                                    ? '<span class="badge bg-success">Running</span>'
                                    : '<span class="badge bg-secondary">Idle</span>';

                                activityHtml += `
                                    <div class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <strong>${collector.source_name}</strong>
                                            ${statusBadge}
                                        </div>
                                        <small class="text-muted">
                                            Last: ${lastCollection} |
                                            Articles: ${collector.articles_collected || 0}
                                        </small>
                                    </div>
                                `;
                            }
                        } else {
                            activityHtml += `
                                <div class="list-group-item text-center text-muted">
                                    <small>No active collectors</small>
                                </div>
                            `;
                        }

                        activityHtml += '</div>';
                        activityDiv.innerHTML = activityHtml;
                    } else {
                        activityDiv.innerHTML = '<div class="text-center text-muted"><small>No activity data available</small></div>';
                    }
                } catch (error) {
                    console.error('Error loading service activity:', error);
                    const activityDiv = document.getElementById('serviceRecentActivity');
                    activityDiv.innerHTML = '<div class="alert alert-warning mb-0 small">Failed to load activity</div>';
                }
            }

            async function loadServiceLogs() {
                try {
                    const logsDiv = document.getElementById('serviceLogs');

                    // Get recent articles as proxy for logs
                    const response = await fetch('/api/news/articles?limit=10', {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    if (!response.ok) {
                        throw new Error('Failed to fetch logs');
                    }

                    const data = await response.json();

                    if (data.success && data.data && data.data.articles) {
                        const articles = data.data.articles;
                        let logsHtml = '';

                        // Generate log entries from recent articles
                        const now = new Date();
                        logsHtml += `<div class="mb-2">[${now.toLocaleString()}] System: Service logs initialized</div>`;
                        logsHtml += `<div class="mb-2">[${now.toLocaleString()}] Info: Found ${articles.length} recent articles in database</div>`;
                        logsHtml += `<div class="mb-2">[${now.toLocaleString()}] Info: Data source: ${data.data.source || 'local_database'}</div>`;

                        if (articles.length > 0) {
                            logsHtml += `<div class="mb-2 text-success">[${now.toLocaleString()}] Success: Latest article from ${articles[0].source_name || 'Unknown'}</div>`;
                            logsHtml += `<div class="mb-2">[${now.toLocaleString()}] Debug: Total sources active: ${new Set(articles.map(a => a.source_name)).size}</div>`;
                        } else {
                            logsHtml += `<div class="mb-2 text-warning">[${now.toLocaleString()}] Warning: No articles found - please collect news</div>`;
                        }

                        logsHtml += `<div class="text-info">[${now.toLocaleString()}] Info: Service ready for collection</div>`;

                        logsDiv.innerHTML = logsHtml;
                        // Auto-scroll to bottom
                        logsDiv.scrollTop = logsDiv.scrollHeight;
                    } else {
                        logsDiv.innerHTML = '<div class="text-warning">No log data available</div>';
                    }
                } catch (error) {
                    console.error('Error loading service logs:', error);
                    const logsDiv = document.getElementById('serviceLogs');
                    const now = new Date();
                    logsDiv.innerHTML = `
                        <div class="text-danger">[${now.toLocaleString()}] Error: Failed to load logs</div>
                        <div class="text-muted">[${now.toLocaleString()}] Info: ${error.message}</div>
                    `;
                }
            }

            window.initializeService = async function() {
                try {
                    const response = await fetch('/api/init', { method: 'POST' });
                    const data = await response.json();

                    if (data.success) {
                        showServiceStatus('Service initialized successfully!', 'success');
                        // Reload activity
                        await loadServiceInfo();
                    } else {
                        showServiceStatus('Error: ' + data.error, 'danger');
                    }
                } catch (error) {
                    showServiceStatus('Error: ' + error.message, 'danger');
                }
            };

            window.startService = async function() {
                try {
                    const response = await fetch('/api/start', { method: 'POST' });
                    const data = await response.json();

                    if (data.success) {
                        showServiceStatus('Service started successfully!', 'success');
                        // Reload activity
                        await loadServiceInfo();
                    } else {
                        showServiceStatus('Error: ' + data.error, 'danger');
                    }
                } catch (error) {
                    showServiceStatus('Error: ' + error.message, 'danger');
                }
            };

            window.stopService = async function() {
                try {
                    const response = await fetch('/api/stop', { method: 'POST' });
                    const data = await response.json();

                    if (data.success) {
                        showServiceStatus('Service stopped successfully!', 'success');
                        // Reload activity
                        await loadServiceInfo();
                    } else {
                        showServiceStatus('Error: ' + data.error, 'danger');
                    }
                } catch (error) {
                    showServiceStatus('Error: ' + error.message, 'danger');
                }
            };

            function showServiceStatus(message, type) {
                const statusDiv = document.getElementById('serviceStatus');
                if (statusDiv) {
                    statusDiv.className = `alert alert-${type}`;
                    statusDiv.textContent = message;
                    statusDiv.style.display = 'block';

                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                    }, 3000);
                }
            }

            // Set active nav link
            const currentPath = window.location.pathname;
            const navLinks = document.querySelectorAll('.nav-link');

            navLinks.forEach(link => {
                if (link.getAttribute('href') === currentPath) {
                    link.classList.add('active');
                }
            });
        }

        // Initialize when DOM is ready and libraries are loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                // Wait a bit for deferred scripts to load
                setTimeout(initializeApp, 100);
            });
        } else {
            // DOM already loaded, wait for scripts
            setTimeout(initializeApp, 100);
        }
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>






