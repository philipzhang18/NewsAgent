{% extends "base.html" %}

{% block title %}新闻文章 - News Agent{% endblock %}
{% block page_title %}Articles{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="h3 mb-4">
                <i class="fas fa-newspaper text-primary me-2"></i>
                <span id="pageTitle">新闻文章</span>
            </h1>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <input type="text" class="form-control" id="searchInput" placeholder="Search articles...">
                                <button class="btn btn-primary" onclick="searchArticles()">
                                    <i class="fas fa-search"></i> Search
                                </button>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="filterSelect" onchange="loadArticles()">
                                <option value="">All Articles</option>
                                <option value="ai">AI News Only</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                                <i class="fas fa-times"></i> Clear Filters
                            </button>
                        </div>
                    </div>
                    <!-- AI Summary Button (shown only for AI articles) -->
                    <div id="aiSummarySection" class="mt-3" style="display: none;">
                        <button class="btn btn-info w-100" onclick="generateAISummary()">
                            <i class="fas fa-brain"></i> Generate AI Analysis Summary
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Summary Result Card -->
    <div id="aiSummaryResult" class="row mb-3" style="display: none;">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-brain"></i> AI News Analysis Summary
                    </h5>
                    <button class="btn btn-sm btn-light" onclick="closeSummary()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="card-body" id="summaryContent">
                    <!-- Summary content will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title mb-0">Article List</h5>
                        <span id="articleCount" class="badge bg-primary">0 articles</span>
                    </div>
                    <div id="articlesContainer">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading articles...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentFilter = '';
let currentQuery = '';

document.addEventListener('DOMContentLoaded', function() {
    // Check URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const aiOnly = urlParams.get('ai_only');

    if (aiOnly === 'true') {
        document.getElementById('filterSelect').value = 'ai';
        document.getElementById('pageTitle').textContent = 'AI新闻文章';
        currentFilter = 'ai';
    }

    // Load articles
    loadArticles();
});

async function loadArticles() {
    const container = document.getElementById('articlesContainer');
    const countBadge = document.getElementById('articleCount');
    const aiSummarySection = document.getElementById('aiSummarySection');

    container.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading articles...</p>
        </div>
    `;

    try {
        const filterValue = document.getElementById('filterSelect').value;
        const aiOnly = filterValue === 'ai';

        // Show/hide AI summary button based on filter
        if (aiOnly) {
            aiSummarySection.style.display = 'block';
        } else {
            aiSummarySection.style.display = 'none';
        }

        let url = '/api/news/articles?limit=10000';
        if (aiOnly) {
            url += '&ai_only=true';
        }
        if (currentQuery) {
            url += '&q=' + encodeURIComponent(currentQuery);
        }

        const resp = await fetch(url);
        const data = await resp.json();

        if (!data.success) {
            container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle"></i>
                    Error loading articles: ${data.error || 'Unknown error'}
                </div>
            `;
            return;
        }

        const articles = (data.data && data.data.articles) ? data.data.articles : [];
        const source = data.data.source || 'unknown';
        const aiFiltered = data.data.ai_filtered || false;

        // Display count with source information
        let countText = `${articles.length} articles`;
        if (source === 'local_database') {
            countText += ' (from local database)';
        } else if (source === 'newsapi') {
            countText += ' (from NewsAPI)';
        }
        countBadge.textContent = countText;

        if (!articles.length) {
            container.innerHTML = `
                <div class="text-center py-5 text-muted">
                    <i class="fas fa-inbox fa-3x mb-3"></i>
                    <p>No articles found</p>
                </div>
            `;
            return;
        }

        container.innerHTML = `
            <div class="row">
                ${articles.map(article => createArticleCard(article)).join('')}
            </div>
        `;

    } catch (e) {
        container.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle"></i>
                Request error: ${e.message}
            </div>
        `;
    }
}

function createArticleCard(article) {
    const sentimentClass = article.sentiment ? `sentiment-${article.sentiment}` : '';
    const sentimentIcon = getSentimentIcon(article.sentiment);
    const publishedDate = article.published_at ? new Date(article.published_at).toLocaleDateString() : 'N/A';

    return `
        <div class="col-md-6 col-lg-4 mb-3">
            <div class="card article-card h-100">
                <div class="card-body">
                    <h6 class="card-title">
                        <a href="${article.url || '#'}" target="_blank" class="text-decoration-none">
                            ${article.title || 'No title'}
                        </a>
                    </h6>
                    <p class="card-text small text-muted">
                        ${article.summary || article.content?.substring(0, 150) || 'No description'}...
                    </p>
                    <div class="d-flex justify-content-between align-items-center mt-auto">
                        <small class="text-muted">
                            <i class="fas fa-rss"></i> ${article.source_name || article.source || 'Unknown'}
                        </small>
                        <span class="${sentimentClass}">${sentimentIcon}</span>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="fas fa-calendar"></i> ${publishedDate}
                        </small>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function getSentimentIcon(sentiment) {
    if (!sentiment) return '<i class="fas fa-minus"></i>';

    const icons = {
        'positive': '<i class="fas fa-smile text-success"></i>',
        'negative': '<i class="fas fa-frown text-danger"></i>',
        'neutral': '<i class="fas fa-meh text-secondary"></i>',
        'mixed': '<i class="fas fa-surprise text-warning"></i>'
    };

    return icons[sentiment] || '<i class="fas fa-minus"></i>';
}

function searchArticles() {
    currentQuery = document.getElementById('searchInput').value;
    loadArticles();
}

function clearFilters() {
    document.getElementById('filterSelect').value = '';
    document.getElementById('searchInput').value = '';
    currentQuery = '';
    currentFilter = '';

    // Update page title
    document.getElementById('pageTitle').textContent = '新闻文章';

    // Update URL
    window.history.pushState({}, '', window.location.pathname);

    loadArticles();
}

// Allow Enter key to trigger search
document.addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && document.activeElement.id === 'searchInput') {
        searchArticles();
    }
});

async function generateAISummary() {
    const summaryContent = document.getElementById('summaryContent');
    const summaryResult = document.getElementById('aiSummaryResult');
    const generateBtn = document.querySelector('button[onclick="generateAISummary()"]');

    // Show loading state
    summaryResult.style.display = 'block';
    generateBtn.disabled = true;
    generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';

    summaryContent.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-info" role="status">
                <span class="visually-hidden">Generating summary...</span>
            </div>
            <p class="mt-2">Analyzing AI news articles and generating summary...</p>
        </div>
    `;

    try {
        const resp = await fetch('/api/news/ai-summary', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await resp.json();

        if (!data.success) {
            summaryContent.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle"></i>
                    Error generating summary: ${data.error || 'Unknown error'}
                </div>
            `;
            return;
        }

        const summary = data.data;

        // Display summary
        summaryContent.innerHTML = `
            <div class="row">
                <div class="col-md-6 mb-3">
                    <h6 class="fw-bold"><i class="fas fa-chart-bar"></i> Overview</h6>
                    <p class="mb-2">Total AI Articles: <span class="badge bg-primary">${summary.total_articles}</span></p>
                    <p class="mb-2">Analysis Period: ${summary.time_period || 'Recent'}</p>
                    <p class="mb-0">Generated at: ${new Date(summary.generated_at).toLocaleString()}</p>
                </div>
                <div class="col-md-6 mb-3">
                    <h6 class="fw-bold"><i class="fas fa-smile"></i> Sentiment Distribution</h6>
                    <div class="d-flex flex-wrap gap-2">
                        ${Object.entries(summary.sentiment_summary).map(([sentiment, count]) => `
                            <span class="badge sentiment-${sentiment}">${sentiment}: ${count}</span>
                        `).join('')}
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <h6 class="fw-bold"><i class="fas fa-lightbulb"></i> Key Insights</h6>
                <ul class="mb-0">
                    ${summary.key_insights.map(insight => `<li>${insight}</li>`).join('')}
                </ul>
            </div>

            <div class="mb-3">
                <h6 class="fw-bold"><i class="fas fa-fire"></i> Trending Topics</h6>
                <div class="d-flex flex-wrap gap-2">
                    ${summary.trending_topics.map(topic => `
                        <span class="badge bg-secondary">${topic}</span>
                    `).join('')}
                </div>
            </div>

            ${summary.ai_summary ? `
                <div class="mb-3">
                    <h6 class="fw-bold"><i class="fas fa-brain"></i> AI Analysis</h6>
                    <p class="mb-0">${summary.ai_summary}</p>
                </div>
            ` : ''}

            <div>
                <h6 class="fw-bold"><i class="fas fa-newspaper"></i> Top Articles</h6>
                <ul class="list-unstyled mb-0">
                    ${summary.top_20_articles.map(article => `
                        <li class="mb-2">
                            <a href="${article.url}" target="_blank" class="text-decoration-none">
                                ${article.title}
                            </a>
                            <small class="text-muted d-block">${article.source} - ${new Date(article.published_at).toLocaleDateString()}</small>
                        </li>
                    `).join('')}
                </ul>
            </div>
        `;

    } catch (e) {
        summaryContent.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle"></i>
                Request error: ${e.message}
            </div>
        `;
    } finally {
        // Restore button state
        generateBtn.disabled = false;
        generateBtn.innerHTML = '<i class="fas fa-brain"></i> Generate AI Analysis Summary';
    }
}

function closeSummary() {
    const summaryResult = document.getElementById('aiSummaryResult');
    summaryResult.style.display = 'none';
}
</script>

<style>
.article-card {
    transition: transform 0.2s, box-shadow 0.2s;
}

.article-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.sentiment-positive {
    color: #28a745;
}

.sentiment-negative {
    color: #dc3545;
}

.sentiment-neutral {
    color: #6c757d;
}

.sentiment-mixed {
    color: #ffc107;
}
</style>
{% endblock %}
